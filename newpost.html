<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Nuevo Post - Mi Blog</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main style="max-width:700px;margin:2rem auto">
    <h1>Nuevo Post</h1>
    <p>Este formulario te permite publicar directamente en tu blog de GitHub.</p>

    <label>T√≠tulo:<br>
      <input id="title" type="text" style="width:100%;padding:6px">
    </label><br><br>

    <label>Extracto (breve descripci√≥n):<br>
      <textarea id="excerpt" rows="2" style="width:100%;padding:6px"></textarea>
    </label><br><br>

    <label>Contenido (Markdown):<br>
      <textarea id="body" rows="10" style="width:100%;padding:6px"></textarea>
    </label><br><br>

    <button id="publish">Publicar</button>
    <p id="msg"></p>
  </main>

  <script>
    const repo = "alfaro29sebass/MiBlog"; // üî∏ c√°mbialo
    const branch = "main";
    const author = "Sebastian"; // üî∏ c√°mbialo

    async function githubFetch(path, options = {}) {
      const token = options.token || prompt("Pega tu token de GitHub:");
      const res = await fetch(`https://api.github.com/repos/${repo}/${path}`, {
        ...options,
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json",
          ...(options.headers || {})
        }
      });
      return {res, token};
    }

    async function createOrUpdateFile(path, content, message, token) {
      const get = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`, {
        headers: {"Authorization": `token ${token}`}
      });
      let sha;
      if (get.ok) {
        const data = await get.json();
        sha = data.sha;
      }

      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
          message,
          content: btoa(unescape(encodeURIComponent(content))),
          branch,
          sha
        })
      });
      return res;
    }

    document.getElementById("publish").onclick = async () => {
      const title = document.getElementById("title").value.trim();
      const excerpt = document.getElementById("excerpt").value.trim();
      const body = document.getElementById("body").value.trim();
      const slug = title.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
      const msg = document.getElementById("msg");

      if (!title || !body) return alert("Falta el t√≠tulo o el contenido.");
      const date = new Date().toISOString().slice(0,10);
      const md = `---\ntitle: "${title}"\ndate: "${date}"\nauthor: "${author}"\n---\n\n${body}\n`;

      msg.textContent = "üì§ Publicando...";
      const token = prompt("Pega tu token de GitHub:");
      if (!token) return alert("Token requerido.");

      // 1Ô∏è‚É£ Subir el nuevo post
      const postRes = await createOrUpdateFile(`posts/${slug}.md`, md, `Nuevo post: ${title}`, token);
      if (!postRes.ok) {
        const err = await postRes.json();
        msg.textContent = "‚ùå Error creando el post: " + (err.message || postRes.status);
        return;
      }

      // 2Ô∏è‚É£ Actualizar posts.json
      const listUrl = `https://api.github.com/repos/${repo}/contents/posts.json?ref=${branch}`;
      const listRes = await fetch(listUrl, {headers: {"Authorization": `token ${token}`}});
      let posts = [];
      let sha;

      if (listRes.ok) {
        const data = await listRes.json();
        sha = data.sha;
        posts = JSON.parse(atob(data.content));
      }

      const newPost = {slug, title, date, author, excerpt};
      posts.push(newPost);
      const newJson = JSON.stringify(posts, null, 2);

      const updateRes = await fetch(`https://api.github.com/repos/${repo}/contents/posts.json`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Accept": "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
          message: `Actualizar posts.json con ${title}`,
          content: btoa(unescape(encodeURIComponent(newJson))),
          branch,
          sha
        })
      });

      if (updateRes.ok) {
        msg.textContent = "‚úÖ Post publicado y lista actualizada.";
      } else {
        msg.textContent = "‚ö†Ô∏è Post subido, pero error al actualizar posts.json.";
      }
    };
  </script>
</body>
</html>
